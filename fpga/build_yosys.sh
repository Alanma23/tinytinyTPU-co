#!/bin/bash
# Yosys/nextpnr build script for TinyTinyTPU
# Complete open-source FPGA toolchain workflow

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RTL_DIR="$SCRIPT_DIR/../rtl"
PROJECT_NAME="tinytinyTPU_basys3"
FPGA_PART="xc7a35tcpg236-1"

echo "=========================================="
echo "Yosys/nextpnr Build Script"
echo "=========================================="
echo "Project: $PROJECT_NAME"
echo "FPGA Part: $FPGA_PART"
echo ""

# Check if Yosys is available
if ! command -v yosys &> /dev/null; then
    echo "ERROR: Yosys not found. Please install Yosys:"
    echo "  Ubuntu/Debian: sudo apt-get install yosys"
    echo "  macOS: brew install yosys"
    exit 1
fi

YOSYS_VERSION=$(yosys -V 2>&1 | head -1)
echo "Found Yosys: $YOSYS_VERSION"
echo ""

# Create Yosys synthesis script
YOSYS_SCRIPT="$SCRIPT_DIR/synth_yosys.ys"
cat > "$YOSYS_SCRIPT" << 'EOF'
# Yosys synthesis script for TinyTinyTPU
# Auto-generated by build_yosys.sh

# Read SystemVerilog RTL files
read_verilog -sv ../rtl/pe.sv
read_verilog -sv ../rtl/mmu.sv
read_verilog -sv ../rtl/weight_fifo.sv
read_verilog -sv ../rtl/dual_weight_fifo.sv
read_verilog -sv ../rtl/accumulator_align.sv
read_verilog -sv ../rtl/accumulator_mem.sv
read_verilog -sv ../rtl/accumulator.sv
read_verilog -sv ../rtl/activation_func.sv
read_verilog -sv ../rtl/normalizer.sv
read_verilog -sv ../rtl/loss_block.sv
read_verilog -sv ../rtl/activation_pipeline.sv
read_verilog -sv ../rtl/unified_buffer.sv
read_verilog -sv ../rtl/mlp_top.sv
read_verilog -sv ../rtl/uart_rx.sv
read_verilog -sv ../rtl/uart_tx.sv
read_verilog -sv ../rtl/uart_controller.sv
read_verilog -sv ../rtl/tpu_bridge.sv
read_verilog -sv ../rtl/tpu_top.sv
read_verilog -sv basys3_top.sv

# Set top module
hierarchy -top basys3_top

# Synthesize for Xilinx 7-series
synth_xilinx -top basys3_top -family xc7

# Write output files
write_verilog basys3_top_yosys.v
write_json basys3_top.json
write_edif basys3_top.edif

# Statistics
stat
EOF

# Replace paths in Yosys script
sed -i.bak "s|../rtl/|$RTL_DIR/|g" "$YOSYS_SCRIPT"
sed -i.bak "s|basys3_top.sv|$SCRIPT_DIR/basys3_top.sv|g" "$YOSYS_SCRIPT"
rm -f "$YOSYS_SCRIPT.bak"

echo "Generated Yosys script: $YOSYS_SCRIPT"
echo ""
echo "Running Yosys synthesis..."
echo "=========================================="

# Run Yosys
cd "$SCRIPT_DIR"
if ! yosys "$YOSYS_SCRIPT" > yosys.log 2>&1; then
    echo "ERROR: Yosys synthesis failed!"
    echo "Check yosys.log for details"
    tail -50 yosys.log
    exit 1
fi

echo "Yosys synthesis completed successfully"
echo "Check yosys.log for detailed output"
echo ""

# Check if nextpnr is available
if ! command -v nextpnr-xilinx &> /dev/null; then
    echo "WARNING: nextpnr-xilinx not found."
    echo "Synthesis complete, but place & route requires nextpnr."
    echo ""
    echo "To install nextpnr-xilinx:"
    echo "  git clone https://github.com/YosysHQ/nextpnr.git"
    echo "  cd nextpnr"
    echo "  cmake . -DARCH=xilinx -DTRELLIS_INSTALL_PREFIX=/usr"
    echo "  make -j\$(nproc)"
    echo "  sudo make install"
    echo ""
    echo "Output files:"
    echo "  - Netlist: basys3_top_yosys.v"
    echo "  - JSON: basys3_top.json"
    echo "  - EDIF: basys3_top.edif"
    exit 0
fi

NEXTPNR_VERSION=$(nextpnr-xilinx --version 2>&1 | head -1)
echo "Found nextpnr-xilinx: $NEXTPNR_VERSION"
echo ""
echo "Running nextpnr place & route..."
echo "=========================================="

# Run nextpnr
XDC_FILE="$SCRIPT_DIR/basys3.xdc"
JSON_FILE="$SCRIPT_DIR/basys3_top.json"
FASM_FILE="$SCRIPT_DIR/basys3_top.fasm"

if ! nextpnr-xilinx \
    --xdc "$XDC_FILE" \
    --json "$JSON_FILE" \
    --write "$SCRIPT_DIR/basys3_top_routed.json" \
    --fasm "$FASM_FILE" \
    > nextpnr.log 2>&1; then
    echo "WARNING: nextpnr place & route had issues:"
    echo "Check nextpnr.log for details"
    tail -50 nextpnr.log
    echo ""
    echo "Note: nextpnr may have limitations compared to Vivado."
    echo "For production builds, use Vivado (build_vivado.tcl)."
    exit 1
fi

echo "nextpnr place & route completed successfully"
echo "Check nextpnr.log for detailed output"
echo ""
echo "=========================================="
echo "Output files:"
echo "  - FASM: $FASM_FILE"
echo "  - Routed JSON: $SCRIPT_DIR/basys3_top_routed.json"
echo ""
echo "Converting FASM to bitstream..."
echo "=========================================="

# Check for fasm2frames (part of prjtrellis)
if command -v fasm2frames &> /dev/null; then
    echo "Found fasm2frames, generating frames..."
    fasm2frames --db "$(prjtrellis-config --sharedir)/database" \
                --part "$FPGA_PART" \
                "$FASM_FILE" \
                "$SCRIPT_DIR/basys3_top.frames" \
        || echo "WARNING: fasm2frames failed"
fi

# Check for xc7frames2bit (part of prjtrellis)
if command -v xc7frames2bit &> /dev/null; then
    if [ -f "$SCRIPT_DIR/basys3_top.frames" ]; then
        echo "Found xc7frames2bit, generating bitstream..."
        xc7frames2bit --part "$FPGA_PART" \
                      --frm_file "$SCRIPT_DIR/basys3_top.frames" \
                      --output_file "$SCRIPT_DIR/basys3_top_yosys.bit" \
            || echo "WARNING: xc7frames2bit failed"
        
        if [ -f "$SCRIPT_DIR/basys3_top_yosys.bit" ]; then
            echo ""
            echo "=========================================="
            echo "SUCCESS: Bitstream generated!"
            echo "  Bitstream: $SCRIPT_DIR/basys3_top_yosys.bit"
            echo "=========================================="
        fi
    fi
fi

# If bitstream generation tools not available, provide instructions
if [ ! -f "$SCRIPT_DIR/basys3_top_yosys.bit" ]; then
    echo ""
    echo "NOTE: Bitstream generation requires prjtrellis tools:"
    echo "  git clone https://github.com/Yowlings/prjtrellis.git"
    echo "  cd prjtrellis/libtrellis"
    echo "  cmake ."
    echo "  make -j\$(nproc)"
    echo "  sudo make install"
    echo ""
    echo "Or use Vivado to convert FASM to bitstream:"
    echo "  vivado -mode tcl"
    echo "  read_fasm basys3_top.fasm"
    echo "  write_bitstream basys3_top.bit"
fi

echo ""
echo "=========================================="
echo "Build Summary"
echo "=========================================="
echo "✓ Yosys synthesis: Complete"
echo "✓ nextpnr place & route: Complete"
if [ -f "$SCRIPT_DIR/basys3_top_yosys.bit" ]; then
    echo "✓ Bitstream generation: Complete"
else
    echo "⚠ Bitstream generation: Requires additional tools"
fi
echo "=========================================="

