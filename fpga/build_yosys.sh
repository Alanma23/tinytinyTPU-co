#!/bin/bash
# Yosys/nextpnr build script for TinyTinyTPU
# Complete open-source FPGA toolchain workflow

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RTL_DIR="$SCRIPT_DIR/../rtl"
PROJECT_NAME="tinytinyTPU_basys3"
FPGA_PART="xc7a35tcpg236-1"

# Default paths for nextpnr-himbaechel (can be overridden with environment variables)
NEXTPNR_BIN="${NEXTPNR_BIN:-$HOME/tools/nextpnr/build/nextpnr-himbaechel}"
NEXTPNR_CHIPDB="${NEXTPNR_CHIPDB:-$HOME/tools/nextpnr/build/share/himbaechel/xilinx/chipdb-xc7a50t.bin}"

echo "=========================================="
echo "Yosys/nextpnr Build Script"
echo "=========================================="
echo "Project: $PROJECT_NAME"
echo "FPGA Part: $FPGA_PART"
echo ""

# Check if Yosys is available
if ! command -v yosys &> /dev/null; then
    echo "ERROR: Yosys not found. Please install Yosys:"
    echo "  Ubuntu/Debian: sudo apt-get install yosys"
    echo "  macOS: brew install yosys"
    exit 1
fi

YOSYS_VERSION=$(yosys -V 2>&1 | head -1)
echo "Found Yosys: $YOSYS_VERSION"
echo ""

# Create Yosys synthesis script
YOSYS_SCRIPT="$SCRIPT_DIR/synth_yosys.ys"
cat > "$YOSYS_SCRIPT" << 'EOF'
# Yosys synthesis script for TinyTinyTPU
# Auto-generated by build_yosys.sh

# Read SystemVerilog RTL files
read_verilog -sv ../rtl/pe.sv
read_verilog -sv ../rtl/mmu.sv
read_verilog -sv ../rtl/weight_fifo.sv
read_verilog -sv ../rtl/dual_weight_fifo.sv
read_verilog -sv ../rtl/accumulator_align.sv
read_verilog -sv ../rtl/accumulator_mem.sv
read_verilog -sv ../rtl/accumulator.sv
read_verilog -sv ../rtl/activation_func.sv
read_verilog -sv ../rtl/normalizer.sv
read_verilog -sv ../rtl/loss_block.sv
read_verilog -sv ../rtl/activation_pipeline.sv
read_verilog -sv ../rtl/unified_buffer.sv
read_verilog -sv ../rtl/mlp_top.sv
read_verilog -sv ../rtl/uart_rx.sv
read_verilog -sv ../rtl/uart_tx.sv
read_verilog -sv ../rtl/uart_controller.sv
read_verilog -sv ../rtl/tpu_bridge.sv
read_verilog -sv ../rtl/tpu_top.sv
read_verilog -sv basys3_top.sv

# Set top module
hierarchy -top basys3_top

# Synthesize for Xilinx 7-series
synth_xilinx -top basys3_top -family xc7

# Write output files
write_verilog basys3_top_yosys.v
write_json basys3_top.json
write_edif basys3_top.edif

# Statistics
stat
EOF

# Replace paths in Yosys script
sed -i.bak "s|../rtl/|$RTL_DIR/|g" "$YOSYS_SCRIPT"
sed -i.bak "s|basys3_top.sv|$SCRIPT_DIR/basys3_top.sv|g" "$YOSYS_SCRIPT"
rm -f "$YOSYS_SCRIPT.bak"

echo "Generated Yosys script: $YOSYS_SCRIPT"
echo ""
echo "Running Yosys synthesis..."
echo "=========================================="

# Run Yosys
cd "$SCRIPT_DIR"
if ! yosys "$YOSYS_SCRIPT" > yosys.log 2>&1; then
    echo "ERROR: Yosys synthesis failed!"
    echo "Check yosys.log for details"
    tail -50 yosys.log
    exit 1
fi

echo "Yosys synthesis completed successfully"
echo "Check yosys.log for detailed output"
echo ""

# Check if nextpnr-himbaechel is available
if [ ! -f "$NEXTPNR_BIN" ]; then
    echo "WARNING: nextpnr-himbaechel not found at: $NEXTPNR_BIN"
    echo ""
    echo "To build nextpnr-himbaechel for Xilinx:"
    echo "  1. Clone nextpnr and prjxray:"
    echo "     cd ~/tools"
    echo "     git clone https://github.com/YosysHQ/nextpnr.git"
    echo "     cd nextpnr && git submodule update --init --recursive"
    echo "     git clone https://github.com/f4pga/prjxray.git ~/tools/prjxray"
    echo "     cd ~/tools/prjxray && bash download-latest-db.sh"
    echo ""
    echo "  2. Build nextpnr-himbaechel:"
    echo "     mkdir -p ~/tools/nextpnr/build && cd ~/tools/nextpnr/build"
    echo "     cmake .. -DARCH=himbaechel -DHIMBAECHEL_UARCH=xilinx \\"
    echo "              -DHIMBAECHEL_XILINX_DEVICES=xc7a50t \\"
    echo "              -DHIMBAECHEL_PRJXRAY_DB=~/tools/prjxray/database \\"
    echo "              -DBUILD_PYTHON=OFF"
    echo "     make -j\$(nproc)"
    echo ""
    echo "Output files from Yosys synthesis:"
    echo "  - Netlist: basys3_top_yosys.v"
    echo "  - JSON: basys3_top.json"
    echo "  - EDIF: basys3_top.edif"
    exit 0
fi

if [ ! -f "$NEXTPNR_CHIPDB" ]; then
    echo "WARNING: nextpnr chipdb not found at: $NEXTPNR_CHIPDB"
    echo "Please build nextpnr with Xilinx support first."
    exit 0
fi

NEXTPNR_VERSION=$("$NEXTPNR_BIN" --version 2>&1 | head -1 || echo "unknown")
echo "Found nextpnr-himbaechel: $NEXTPNR_VERSION"
echo ""
echo "Running nextpnr place & route..."
echo "=========================================="

# Run nextpnr-himbaechel
XDC_FILE="$SCRIPT_DIR/basys3_nextpnr.xdc"
JSON_FILE="$SCRIPT_DIR/basys3_top.json"
FASM_FILE="$SCRIPT_DIR/basys3_top_nextpnr.fasm"

if ! "$NEXTPNR_BIN" \
    --device "$FPGA_PART" \
    --chipdb "$NEXTPNR_CHIPDB" \
    --json "$JSON_FILE" \
    -o xdc="$XDC_FILE" \
    -o fasm="$FASM_FILE" \
    --router router2 \
    > nextpnr.log 2>&1; then
    echo "WARNING: nextpnr place & route had issues:"
    echo "Check nextpnr.log for details"
    tail -50 nextpnr.log
    echo ""
    echo "Note: nextpnr-himbaechel for Xilinx is experimental."
    echo "For production builds, use Vivado (build_vivado.tcl)."
    exit 1
fi

echo "nextpnr place & route completed successfully"
echo "Check nextpnr.log for detailed output"
echo ""
echo "=========================================="
echo "Output files:"
echo "  - FASM: $FASM_FILE"
echo ""
echo "Converting FASM to bitstream..."
echo "=========================================="

# For Xilinx 7-series, we need fasm2frames from prjxray and xc7frames2bit
PRJXRAY_DIR="${PRJXRAY_DIR:-$HOME/tools/prjxray}"

if [ -f "$PRJXRAY_DIR/utils/fasm2frames.py" ]; then
    echo "Found fasm2frames, generating frames..."
    python3 "$PRJXRAY_DIR/utils/fasm2frames.py" \
        --db-root "$PRJXRAY_DIR/database/artix7" \
        --part "$FPGA_PART" \
        "$FASM_FILE" \
        "$SCRIPT_DIR/basys3_top.frames" 2>&1 || echo "WARNING: fasm2frames failed"

    if [ -f "$SCRIPT_DIR/basys3_top.frames" ] && [ -f "$PRJXRAY_DIR/utils/xc7frames2bit.py" ]; then
        echo "Found xc7frames2bit, generating bitstream..."
        python3 "$PRJXRAY_DIR/utils/xc7frames2bit.py" \
            --db-root "$PRJXRAY_DIR/database/artix7" \
            --part "$FPGA_PART" \
            --frm_file "$SCRIPT_DIR/basys3_top.frames" \
            --output_file "$SCRIPT_DIR/basys3_top_yosys.bit" 2>&1 || echo "WARNING: xc7frames2bit failed"
    fi
fi

if [ -f "$SCRIPT_DIR/basys3_top_yosys.bit" ]; then
    echo ""
    echo "=========================================="
    echo "SUCCESS: Bitstream generated!"
    echo "  Bitstream: $SCRIPT_DIR/basys3_top_yosys.bit"
    echo "=========================================="
else
    echo ""
    echo "NOTE: Bitstream generation requires prjxray tools."
    echo "The FASM file has been generated and can be converted to bitstream"
    echo "using prjxray's fasm2frames.py and xc7frames2bit.py scripts."
    echo ""
    echo "For more information, see: https://github.com/f4pga/prjxray"
fi

echo ""
echo "=========================================="
echo "Build Summary"
echo "=========================================="
echo "Yosys synthesis: Complete"
echo "nextpnr place & route: Complete"
if [ -f "$SCRIPT_DIR/basys3_top_yosys.bit" ]; then
    echo "Bitstream generation: Complete"
else
    echo "Bitstream generation: FASM generated (use prjxray for .bit)"
fi
echo "=========================================="
